{% extends 'main_app/base.html' %}
{% load static %}  <!-- è¿™è¡Œå¿…é¡»æœ‰ -->

{% block title %}æ•°æ®å¤§å± - æˆ¿åœ°äº§æ•°æ®åˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>æ•°æ®å¤§å±</h1>

<!--    &lt;!&ndash; è°ƒè¯•ä¿¡æ¯åŒºåŸŸï¼ˆæ­£å¸¸æ˜¾ç¤ºåå¯åˆ é™¤ï¼‰ &ndash;&gt;-->
<!--    <div class="alert alert-info alert-dismissible fade show" role="alert">-->
<!--        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>-->
<!--        <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong>-->
<!--        å½“å‰æ—¶é—´æˆ³ï¼š<code>{{ timestamp }}</code> |-->
<!--        å›¾ç‰‡è·¯å¾„ï¼š<code id="debug-path">{% static 'img/10.png' %}</code>-->
<!--        <button class="btn btn-sm btn-secondary ms-2" onclick="copyPath()">å¤åˆ¶è·¯å¾„</button>-->
<!--        <span class="ms-2">|</span>-->
<!--        <a href="{% static 'img/10.png' %}" target="_blank" class="alert-link">ç›´æ¥æ‰“å¼€å›¾ç‰‡</a>-->
<!--        <span class="ms-2">|</span>-->
<!--        <a href="/dashboard/?t={{ timestamp }}" class="alert-link">å¼ºåˆ¶åˆ·æ–°é¡µé¢</a>-->
<!--    </div>-->

<!--    &lt;!&ndash; æ–°å¢ï¼šæ’å…¥å›¾ç‰‡åŒºåŸŸ &ndash;&gt;-->
<!--    <div class="row mt-4">-->
<!--        <div class="col-md-12">-->
<!--            <div class="card">-->
<!--                <div class="card-header d-flex justify-content-between align-items-center">-->
<!--                    <h5 class="card-title mb-0">æˆ¿ä»·è¶‹åŠ¿å¯è§†åŒ–</h5>-->
<!--                    <small class="text-muted">ç‰ˆæœ¬ï¼š{{ timestamp|default:"1.0" }}</small>-->
<!--                </div>-->
<!--                <div class="card-body text-center">-->

<!--                    &lt;!&ndash; æ–¹æ³•1ï¼šä¸»è¦æ˜¾ç¤ºå›¾ç‰‡ï¼ˆå¸¦æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼‰ &ndash;&gt;-->
<!--                    <div class="mb-4">-->
<!--                        <h6>æ–¹æ³•1ï¼šä½¿ç”¨staticæ ‡ç­¾</h6>-->
<!--                        <img src="{% static 'img/10.png' %}?v={{ timestamp|default:'1.0' }}"-->
<!--                             alt="æˆ¿ä»·è¶‹åŠ¿å›¾è¡¨"-->
<!--                             class="img-fluid rounded border border-3"-->
<!--                             style="max-height: 400px;"-->
<!--                             id="main-image"-->
<!--                             onload="onImageLoad(this)"-->
<!--                             onerror="onImageError(this)">-->
<!--                        <p class="text-muted mt-2">é™æ€æ ‡ç­¾å¼•ç”¨ | è·¯å¾„: {% static 'img/10.png' %}?v={{ timestamp }}</p>-->
<!--                    </div>-->

<!--                    <hr>-->

<!--                    &lt;!&ndash; æ–¹æ³•2ï¼šå¤‡ç”¨æ–¹æ¡ˆï¼Œç›´æ¥è·¯å¾„ &ndash;&gt;-->
<!--                    <div class="mt-4">-->
<!--                        <h6>æ–¹æ³•2ï¼šç›´æ¥è·¯å¾„ï¼ˆå¤‡ç”¨ï¼‰</h6>-->
<!--                        <img src="/static/img/10.png?v={{ timestamp|default:'1.0' }}"-->
<!--                             alt="æˆ¿ä»·è¶‹åŠ¿å›¾è¡¨-å¤‡ç”¨"-->
<!--                             class="img-fluid rounded border border-success"-->
<!--                             style="max-height: 200px;"-->
<!--                             onload="onImageLoad(this)"-->
<!--                             onerror="onImageError(this)">-->
<!--                        <p class="text-muted mt-2">ç›´æ¥URLå¼•ç”¨ | è·¯å¾„: /static/img/10.png?v={{ timestamp }}</p>-->
<!--                    </div>-->

<!--                </div>-->
<!--                <div class="card-footer text-muted small">-->
<!--                    <div class="row">-->
<!--                        <div class="col">-->
<!--                            å›¾ç‰‡çŠ¶æ€ï¼š<span id="image-status">åŠ è½½ä¸­...</span>-->
<!--                        </div>-->
<!--                        <div class="col text-end">-->
<!--                            ä»Šæ—¥æ–°å¢ï¼š{{ today_count }} | æœ€åæ›´æ–°ï¼š{{ last_update|date:"Y-m-d H:i" }}-->
<!--                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="reloadImage()">-->
<!--                                ğŸ”„ é‡æ–°åŠ è½½å›¾ç‰‡-->
<!--                            </button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
  <!-- ã€æ›¿æ¢å¼€å§‹ã€‘åŸæ¥çš„å›¾ç‰‡åŒºåŸŸæ¢æˆå›¾è¡¨åŒºåŸŸ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">ğŸ  å…¨å›½8å¤§åŸå¸‚æˆ¿äº§å¸‚åœºäº¤äº’å¼å¤§å±</h5>
                <small class="text-muted">å®æ—¶æ•°æ® | æ”¯æŒäº¤äº’åˆ†æ</small>
            </div>
            <div class="card-body p-0" style="height: 700px;">
                <!-- æ ¸å¿ƒï¼šåµŒå…¥ä½ çš„å¯è§†åŒ–å›¾è¡¨ -->
                <iframe
                    src="/static/charts/æˆ¿äº§æ•°æ®å¤§å±.html"
                    style="width:100%; height:100%; border:none;"
                    title="æˆ¿äº§æ•°æ®å¯è§†åŒ–å¤§å±"
                    frameborder="0">
                </iframe>
            </div>
            <div class="card-footer text-muted small">
                <div class="row">
                    <div class="col">
                        å›¾è¡¨çŠ¶æ€ï¼š<span class="text-success">âœ… å·²åŠ è½½</span> |
                        äº¤äº’åŠŸèƒ½ï¼šæ‚¬åœæŸ¥çœ‹è¯¦æƒ…ã€ç¼©æ”¾ã€ç­›é€‰
                    </div>
                    <div class="col text-end">
                        ä»Šæ—¥æ–°å¢ï¼š{{ today_count }} | æœ€åæ›´æ–°ï¼š{{ last_update|date:"Y-m-d H:i" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ã€æ›¿æ¢ç»“æŸã€‘ -->
    <!-- ã€é‡è¦ã€‘ä½ åŸæœ‰çš„ä¸‰ä¸ªç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">æ€»æˆ¿æºæ•°</h5>
                    <p class="card-text display-4">{{ total_houses|default:"0" }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">åŒºåŸŸæ•°é‡</h5>
                    <p class="card-text display-4">{{ district_count|default:"0" }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">å¹³å‡å•ä»·</h5>
                    <p class="card-text display-4">{{ avg_price|default:"0.00" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ€æœ¯ä¿¡æ¯é¢æ¿ï¼ˆè°ƒè¯•ç”¨ï¼‰ -->
    <div class="card mt-4 border-secondary">
        <div class="card-header bg-light">
            <h6 class="mb-0">æŠ€æœ¯ä¿¡æ¯</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>é™æ€æ–‡ä»¶è·¯å¾„è§£æï¼š</strong></p>
                    <code>{% static 'img/10.png' %}</code> â†’
                    <code id="resolved-path">æ­£åœ¨è§£æ...</code>
                    <p class="mt-2"><strong>é¡µé¢æ¥æ”¶åˆ°çš„æ•°æ®ï¼š</strong></p>
                    <ul>
                        <li>total_houses: {{ total_houses }}</li>
                        <li>district_count: {{ district_count }}</li>
                        <li>avg_price: {{ avg_price }}</li>
                        <li>timestamp: {{ timestamp }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <p><strong>è°ƒè¯•æ“ä½œï¼š</strong></p>
                    <button class="btn btn-sm btn-info me-2 mb-2" onclick="checkImage()">æ£€æŸ¥å›¾ç‰‡çŠ¶æ€</button>
                    <button class="btn btn-sm btn-warning me-2 mb-2" onclick="clearCache()">æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°</button>
                    <button class="btn btn-sm btn-danger mb-2" onclick="hardRefresh()">å¼ºåˆ¶å®Œå…¨åˆ·æ–°</button>
                    <p class="mt-3"><strong>ç›´æ¥é“¾æ¥æµ‹è¯•ï¼š</strong></p>
                    <p><a href="/static/img/10.png" target="_blank">1. ç›´æ¥æ‰“å¼€å›¾ç‰‡</a></p>
                    <p><a href="/static/img/10.png?v={{ timestamp }}" target="_blank">2. å¸¦æ—¶é—´æˆ³æ‰“å¼€</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç®€å•JavaScriptç”¨äºè°ƒè¯• -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ˜¾ç¤ºè§£æåçš„è·¯å¾„
    const imgElement = document.getElementById('main-image');
    if(imgElement) {
        document.getElementById('resolved-path').textContent = imgElement.src;
    }

    // æ£€æŸ¥å›¾ç‰‡åŠ è½½çŠ¶æ€
    setTimeout(checkImage, 1000);

    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ—¶é—´æˆ³:', {{ timestamp }});
});

function onImageLoad(imgElement) {
    console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', imgElement.src);
    checkImage();
}

function onImageError(imgElement) {
    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', imgElement.src);
    document.getElementById('image-status').innerHTML =
        '<span class="text-danger">âŒ å›¾ç‰‡åŠ è½½å‡ºé”™ï¼Œæ£€æŸ¥æ§åˆ¶å°</span>';
}

function checkImage() {
    const img = document.getElementById('main-image');
    const statusEl = document.getElementById('image-status');

    if(img && img.complete) {
        if(img.naturalHeight !== 0) {
            statusEl.innerHTML = '<span class="text-success">âœ… åŠ è½½æˆåŠŸ</span>';
            statusEl.innerHTML += ` (å°ºå¯¸: ${img.naturalWidth}Ã—${img.naturalHeight})`;
        } else {
            statusEl.innerHTML = '<span class="text-danger">âŒ åŠ è½½å¤±è´¥ - å›¾ç‰‡é«˜åº¦ä¸º0</span>';
        }
    } else {
        statusEl.innerHTML = '<span class="text-warning">â³ ä»åœ¨åŠ è½½...</span>';
    }
}

function reloadImage() {
    const img = document.getElementById('main-image');
    const newSrc = img.src.split('?')[0] + '?v=' + new Date().getTime();
    img.src = newSrc;
    document.getElementById('image-status').innerHTML = '<span class="text-warning">ğŸ”„ é‡æ–°åŠ è½½ä¸­...</span>';

    console.log('é‡æ–°åŠ è½½å›¾ç‰‡:', newSrc);
}

function copyPath() {
    const path = document.getElementById('debug-path').textContent;
    navigator.clipboard.writeText(path).then(() => {
        alert('è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + path);
    });
}

function clearCache() {
    // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œç»•è¿‡ç¼“å­˜
    window.location.href = window.location.pathname + '?t=' + new Date().getTime();
}

function hardRefresh() {
    // å¼ºåˆ¶å®Œå…¨åˆ·æ–°ï¼ˆç­‰æ•ˆäºCtrl+Shift+Rï¼‰
    if (window.location.search) {
        window.location.href = window.location.pathname + window.location.search + '&hard=' + new Date().getTime();
    } else {
        window.location.href = window.location.pathname + '?hard=' + new Date().getTime();
    }
}
</script>

<style>
#main-image {
    transition: opacity 0.3s;
    background-color: #f8f9fa; /* æ·»åŠ èƒŒæ™¯è‰²ï¼Œæ–¹ä¾¿æŸ¥çœ‹å›¾ç‰‡åŒºåŸŸ */
}
#main-image:hover {
    opacity: 0.9;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
}
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}